name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - platform: darwin/amd64
            arch: amd64
          - platform: darwin/arm64
            arch: arm64

    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pdfplumber rapidocr-onnxruntime pymupdf opencv-python-headless

      - name: Build Python Bridge
        run: |
          # ä½¿ç”¨ --collect-all å¼ºåˆ¶æ”¶é›† OCR åº“çš„æ‰€æœ‰éšå¼ä¾èµ–(æ¨¡åž‹ã€åŠ¨æ€åº“ç­‰) - å•è¡Œå‘½ä»¤ä»¥å…¼å®¹ Windows PowerShell
          python -m PyInstaller --onefile --clean --distpath internal/extractor/bridge_bin --name pdf_extractor_core --collect-all rapidocr_onnxruntime --collect-all onnxruntime --collect-all pyclipper internal/extractor/bridge_bin/pdf_bridge.py

      - name: Build Wails App
        run: |
          # macOS æ˜¾å¼æž„å»ºæ¨¡å¼ï¼šæ‰‹åŠ¨å®‰è£…ä¾èµ–å¹¶æž„å»ºï¼Œé¿å… Wails å†…éƒ¨çŽ¯å¢ƒè·¯å¾„é—®é¢˜
          cd frontend
          npm install
          npm run build
          cd ..

          # è·³è¿‡ Wails å†…ç½®å‰ç«¯æž„å»ºï¼Œç›´æŽ¥ä½¿ç”¨ç”Ÿæˆçš„ dist
          wails build -platform ${{ matrix.platform }} -s

      - name: Inject Python Bridge (macOS)
        run: |
          # æ‰‹åŠ¨å°†ç¼–è¯‘å¥½çš„ Python äºŒè¿›åˆ¶æ³¨å…¥åˆ° App Bundle çš„èµ„æºç›®å½•
          APP_RESOURCES="build/bin/legal-extractor.app/Contents/Resources"
          mkdir -p "$APP_RESOURCES/bridge_bin"
          cp internal/extractor/bridge_bin/pdf_extractor_core "$APP_RESOURCES/bridge_bin/"
          echo "âœ… Python bridge injected into $APP_RESOURCES/bridge_bin/"
          ls -R "$APP_RESOURCES/bridge_bin/"

      - name: Aggressive Cleanup for Space
        run: |
          echo "ðŸ§¹ Performing aggressive cleanup to free space..."

          # 1. æ¸…ç†ç¼“å­˜ (ä½¿ç”¨ sudo å¼ºåˆ¶åˆ é™¤åªè¯»æ–‡ä»¶ï¼Œå¦‚ Go mod cache)
          sudo rm -rf ~/Library/Caches/pip
          sudo rm -rf ~/.cache
          sudo rm -rf ~/.npm
          sudo rm -rf ~/go/pkg/mod
          sudo rm -rf ~/Library/Caches/go-build

          # 2. åˆ é™¤å·²ç¼–è¯‘å®Œçš„æºç ç›®å½• (åªä¿ç•™ build/bin)
          # æ³¨æ„ï¼šä¸è¦åˆ é™¤ build/binï¼Œé‚£æ˜¯äº§ç‰©ç›®å½•
          sudo rm -rf frontend
          sudo rm -rf internal
          sudo rm -rf .git
          # ä¿ç•™ .github ä»¥é˜² runner éœ€è¦è¯»å–å…ƒæ•°æ®

          # 3. åˆ é™¤ PyInstaller ä¸´æ—¶ç›®å½•
          sudo rm -rf build/pdf_extractor_core

          echo "âœ… Cleanup complete. Available space:"
          df -h

      - name: Create DMG (Manual Method)
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION="dev"
          fi

          APP_NAME="legal-extractor.app"
          APP_PATH="build/bin/$APP_NAME"
          DMG_NAME="legal-extractor_${VERSION}_darwin_${{ matrix.arch }}.dmg"

          if [ -d "$APP_PATH" ]; then
            echo "ðŸ“¦ Packaging $APP_PATH into $DMG_NAME..."

            # 1. åˆ›å»ºä¸€ä¸ªè¶³å¤Ÿå¤§(2GB)çš„ä¸´æ—¶ç¨€ç–é•œåƒï¼Œé¿å…è‡ªåŠ¨ä¼°ç®—ç©ºé—´ä¸è¶³
            # ä½¿ç”¨ sparseimage ä¸ä¼šç«‹å³å ç”¨2GBç‰©ç†ç©ºé—´
            # æ³¨æ„ï¼šå·åä¸èƒ½åŒ…å«ç©ºæ ¼ï¼Œå¦åˆ™åŽç»­ awk è§£æžæŒ‚è½½ç‚¹ä¼šå‡ºé”™
            hdiutil create -size 2g -volname "LegalExtractor" -type SPARSE -fs HFS+ -fsargs "-c c=64,a=16,e=16" tmp_image

            # 2. æŒ‚è½½é•œåƒ
            # -nobrowse: ä¸åœ¨ Finder æ˜¾ç¤º
            # -noverify: ä¸éªŒè¯
            # -noautoopen: ä¸è‡ªåŠ¨æ‰“å¼€
            MOUNT_POINT=$(hdiutil attach -nobrowse -noverify -noautoopen tmp_image.sparseimage | grep "Apple_HFS" | awk '{print $3}')
            echo "ðŸ’¿ Mounted at: $MOUNT_POINT"

            # 3. å¤åˆ¶ App åˆ°é•œåƒä¸­
            cp -R "$APP_PATH" "$MOUNT_POINT/"

            # 4. åˆ›å»º /Applications è½¯é“¾æŽ¥ (å¯é€‰ï¼Œæ–¹ä¾¿ç”¨æˆ·æ‹–æ‹½å®‰è£…)
            ln -s /Applications "$MOUNT_POINT/Applications"

            # 5. å¸è½½é•œåƒ
            hdiutil detach "$MOUNT_POINT"

            # 6. è½¬æ¢ä¸ºæœ€ç»ˆçš„åŽ‹ç¼© DMG (UDZO)
            hdiutil convert tmp_image.sparseimage -format UDZO -o "build/bin/$DMG_NAME"

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm tmp_image.sparseimage

            # åŒæ—¶ä¿ç•™ tar.gz ä½œä¸ºå¤‡é€‰
            cd build/bin
            tar -czf legal-extractor_${VERSION}_darwin_${{ matrix.arch }}.app.tar.gz legal-extractor.app

            echo "âœ… Packaging complete:"
            ls -lah *.dmg *.tar.gz
          else
            echo "âŒ App bundle not found at $APP_PATH"
            exit 1
          fi

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            build/bin/*.dmg
            build/bin/*.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pdfplumber rapidocr-onnxruntime pymupdf opencv-python-headless

      - name: Build Python Bridge
        run: |
          # ä½¿ç”¨ --collect-all å¼ºåˆ¶æ”¶é›† OCR åº“çš„æ‰€æœ‰éšå¼ä¾èµ–(æ¨¡åž‹ã€åŠ¨æ€åº“ç­‰) - å•è¡Œå‘½ä»¤ä»¥å…¼å®¹ Windows PowerShell
          python -m PyInstaller --onefile --clean --distpath internal/extractor/bridge_bin --name pdf_extractor_core --collect-all rapidocr_onnxruntime --collect-all onnxruntime --collect-all pyclipper internal/extractor/bridge_bin/pdf_bridge.py

      - name: Build Wails App
        shell: powershell
        run: |
          # Windows æ˜¾å¼æž„å»ºæ¨¡å¼ï¼šæ‰‹åŠ¨å®‰è£…ä¾èµ–å¹¶æž„å»º
          cd frontend
          npm install
          npm run build
          cd ..

          # è·³è¿‡ Wails å†…ç½®å‰ç«¯æž„å»º
          wails build -platform windows/amd64 -s

      - name: Inject Python Bridge (Windows)
        shell: powershell
        run: |
          # æ‰‹åŠ¨å°†ç¼–è¯‘å¥½çš„ Python äºŒè¿›åˆ¶æ³¨å…¥åˆ°å‘å¸ƒç›®å½•
          $BridgeDir = "build/bin/bridge_bin"
          New-Item -ItemType Directory -Force -Path $BridgeDir
          Copy-Item "internal/extractor/bridge_bin/pdf_extractor_core.exe" -Destination "$BridgeDir/"
          Write-Host "âœ… Python bridge injected into $BridgeDir/"
          Get-ChildItem -Recurse $BridgeDir

      - name: Package Windows
        shell: powershell
        run: |
          $VERSION = "${{ github.ref_name }}" -replace "v",""
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "dev" }

          cd build/bin
          if (Test-Path "legal-extractor.exe") {
            $TargetName = "legal-extractor_${VERSION}_windows_amd64.exe"
            Copy-Item "legal-extractor.exe" -Destination $TargetName
            Compress-Archive -Path "legal-extractor.exe" -DestinationPath "legal-extractor_${VERSION}_windows_amd64.zip"
            Get-ChildItem *.exe, *.zip
          } else {
            Write-Error "âŒ Windows executable not found"
            exit 1
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: |
            build/bin/*.exe
            build/bin/*.zip

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Prepare Release Assets
        run: |
          mkdir -p final-assets
          VERSION=${GITHUB_REF#refs/tags/v}

          echo "ðŸ“¦ Collecting release assets..."

          # macOS amd64
          if [ -d "release-assets/macos-amd64" ]; then
            cp release-assets/macos-amd64/*.dmg final-assets/ 2>/dev/null || true
            cp release-assets/macos-amd64/*.tar.gz final-assets/ 2>/dev/null || true
          fi

          # macOS arm64
          if [ -d "release-assets/macos-arm64" ]; then
            cp release-assets/macos-arm64/*.dmg final-assets/ 2>/dev/null || true
            cp release-assets/macos-arm64/*.tar.gz final-assets/ 2>/dev/null || true
          fi

          # Windows
          if [ -d "release-assets/windows-amd64" ]; then
            # åªå¤åˆ¶å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶ï¼Œé¿å…é‡å¤
            cp release-assets/windows-amd64/*_windows_amd64.exe final-assets/legal-extractor_${VERSION}_windows_amd64_setup.exe 2>/dev/null || true
            cp release-assets/windows-amd64/*.zip final-assets/ 2>/dev/null || true
          fi

          echo "ðŸ“‹ Final assets:"
          ls -lah final-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: final-assets/*
          body_path: RELEASE_NOTES_${{ github.ref_name }}.md
          generate_release_notes: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
