name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - platform: darwin/amd64
            arch: amd64
          - platform: darwin/arm64
            arch: arm64

    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pdfplumber rapidocr-onnxruntime pymupdf opencv-python-headless

      - name: Build Python Bridge
        run: |
          python -m PyInstaller --onefile --clean --distpath internal/extractor/bridge_bin --name pdf_extractor_core internal/extractor/bridge_bin/pdf_bridge.py

      - name: Build Wails App
        run: |
          # macOS æ˜¾å¼æž„å»ºæ¨¡å¼ï¼šæ‰‹åŠ¨å®‰è£…ä¾èµ–å¹¶æž„å»ºï¼Œé¿å… Wails å†…éƒ¨çŽ¯å¢ƒè·¯å¾„é—®é¢˜
          cd frontend
          npm install
          npm run build
          cd ..

          # è·³è¿‡ Wails å†…ç½®å‰ç«¯æž„å»ºï¼Œç›´æŽ¥ä½¿ç”¨ç”Ÿæˆçš„ dist
          wails build -platform ${{ matrix.platform }} -s

      - name: Inject Python Bridge (macOS)
        run: |
          # æ‰‹åŠ¨å°†ç¼–è¯‘å¥½çš„ Python äºŒè¿›åˆ¶æ³¨å…¥åˆ° App Bundle çš„èµ„æºç›®å½•
          APP_RESOURCES="build/bin/legal-extractor.app/Contents/Resources"
          mkdir -p "$APP_RESOURCES/bridge_bin"
          cp internal/extractor/bridge_bin/pdf_extractor_core "$APP_RESOURCES/bridge_bin/"
          echo "âœ… Python bridge injected into $APP_RESOURCES/bridge_bin/"
          ls -R "$APP_RESOURCES/bridge_bin/"

      - name: Aggressive Cleanup for Space
        run: |
          echo "ðŸ§¹ Performing aggressive cleanup to free space..."

          # 1. æ¸…ç†ç¼“å­˜ (macOS è·¯å¾„ä¿®æ­£)
          rm -rf ~/Library/Caches/pip
          rm -rf ~/.cache
          rm -rf ~/.npm
          rm -rf ~/go/pkg/mod
          rm -rf ~/Library/Caches/go-build

          # 2. åˆ é™¤å·²ç¼–è¯‘å®Œçš„æºç ç›®å½• (åªä¿ç•™ build/bin)
          # æ³¨æ„ï¼šä¸è¦åˆ é™¤ build/binï¼Œé‚£æ˜¯äº§ç‰©ç›®å½•
          rm -rf frontend
          rm -rf internal
          rm -rf .git
          rm -rf .github

          # 3. åˆ é™¤ PyInstaller ä¸´æ—¶ç›®å½•
          rm -rf build/pdf_extractor_core

          echo "âœ… Cleanup complete. Available space:"
          df -h

      - name: Create DMG
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION="dev"
          fi

          APP_PATH="build/bin/legal-extractor.app"
          if [ -d "$APP_PATH" ]; then
            # åˆ›å»º tar.gz åŽ‹ç¼©åŒ…
            cd build/bin
            tar -czf legal-extractor_${VERSION}_darwin_${{ matrix.arch }}.app.tar.gz legal-extractor.app
            
            # ä½¿ç”¨ hdiutil åˆ›å»ºçœŸæ­£çš„ DMG æ–‡ä»¶ï¼ˆåœ¨ macOS runner ä¸Šæ‰§è¡Œï¼‰
            hdiutil create -volname "Legal Extractor" \
              -srcfolder legal-extractor.app \
              -ov -format UDZO \
              legal-extractor_${VERSION}_darwin_${{ matrix.arch }}.dmg
            
            ls -lah *.dmg *.tar.gz
          else
            echo "âŒ App bundle not found at $APP_PATH"
            exit 1
          fi

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            build/bin/*.dmg
            build/bin/*.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pdfplumber rapidocr-onnxruntime pymupdf opencv-python-headless

      - name: Build Python Bridge
        run: |
          python -m PyInstaller --onefile --clean --distpath internal/extractor/bridge_bin --name pdf_extractor_core internal/extractor/bridge_bin/pdf_bridge.py

      - name: Build Wails App
        shell: powershell
        run: |
          # Windows æ˜¾å¼æž„å»ºæ¨¡å¼ï¼šæ‰‹åŠ¨å®‰è£…ä¾èµ–å¹¶æž„å»º
          cd frontend
          npm install
          npm run build
          cd ..

          # è·³è¿‡ Wails å†…ç½®å‰ç«¯æž„å»º
          wails build -platform windows/amd64 -s

      - name: Inject Python Bridge (Windows)
        shell: powershell
        run: |
          # æ‰‹åŠ¨å°†ç¼–è¯‘å¥½çš„ Python äºŒè¿›åˆ¶æ³¨å…¥åˆ°å‘å¸ƒç›®å½•
          $BridgeDir = "build/bin/bridge_bin"
          New-Item -ItemType Directory -Force -Path $BridgeDir
          Copy-Item "internal/extractor/bridge_bin/pdf_extractor_core.exe" -Destination "$BridgeDir/"
          Write-Host "âœ… Python bridge injected into $BridgeDir/"
          Get-ChildItem -Recurse $BridgeDir

      - name: Package Windows
        shell: powershell
        run: |
          $VERSION = "${{ github.ref_name }}" -replace "v",""
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "dev" }

          cd build/bin
          if (Test-Path "legal-extractor.exe") {
            $TargetName = "legal-extractor_${VERSION}_windows_amd64.exe"
            Copy-Item "legal-extractor.exe" -Destination $TargetName
            Compress-Archive -Path "legal-extractor.exe" -DestinationPath "legal-extractor_${VERSION}_windows_amd64.zip"
            Get-ChildItem *.exe, *.zip
          } else {
            Write-Error "âŒ Windows executable not found"
            exit 1
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: |
            build/bin/*.exe
            build/bin/*.zip

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Prepare Release Assets
        run: |
          mkdir -p final-assets
          VERSION=${GITHUB_REF#refs/tags/v}

          echo "ðŸ“¦ Collecting release assets..."

          # macOS amd64
          if [ -d "release-assets/macos-amd64" ]; then
            cp release-assets/macos-amd64/*.dmg final-assets/ 2>/dev/null || true
            cp release-assets/macos-amd64/*.tar.gz final-assets/ 2>/dev/null || true
          fi

          # macOS arm64
          if [ -d "release-assets/macos-arm64" ]; then
            cp release-assets/macos-arm64/*.dmg final-assets/ 2>/dev/null || true
            cp release-assets/macos-arm64/*.tar.gz final-assets/ 2>/dev/null || true
          fi

          # Windows
          if [ -d "release-assets/windows-amd64" ]; then
            # åªå¤åˆ¶å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶ï¼Œé¿å…é‡å¤
            cp release-assets/windows-amd64/*_windows_amd64.exe final-assets/legal-extractor_${VERSION}_windows_amd64_setup.exe 2>/dev/null || true
            cp release-assets/windows-amd64/*.zip final-assets/ 2>/dev/null || true
          fi

          echo "ðŸ“‹ Final assets:"
          ls -lah final-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: final-assets/*
          body_path: RELEASE_NOTES_${{ github.ref_name }}.md
          generate_release_notes: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
