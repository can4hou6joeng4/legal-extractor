name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - platform: darwin/amd64
            arch: amd64
          - platform: darwin/arm64
            arch: arm64

    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Wails App
        env:
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
          BAIDU_TOKEN: ${{ secrets.BAIDU_TOKEN }}
        run: |
          # ä»Ž GitHub Secrets ç”ŸæˆåµŒå…¥é…ç½®
          mkdir -p internal/config
          cat > internal/config/baked_conf.yaml << EOF
          tencent:
            secret_id: "${TENCENT_SECRET_ID}"
            secret_key: "${TENCENT_SECRET_KEY}"
          baidu:
            token: "${BAIDU_TOKEN}"
          EOF

          cd frontend
          npm install
          npm run build
          cd ..

          # æ³¨å…¥æž„å»ºæ—¶é—´æˆ³å¹¶æž„å»ºåŽŸç”Ÿåº”ç”¨
          BUILD_TIME=$(date +%s)
          wails build -platform ${{ matrix.platform }} -s -ldflags "-X 'legal-extractor/internal/config.BuildTime=$BUILD_TIME'"

      - name: Create DMG (Manual Method)
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION="dev"
          fi

          APP_NAME="legal-extractor.app"
          APP_PATH="build/bin/$APP_NAME"
          DMG_NAME="legal-extractor_${VERSION}_darwin_${{ matrix.arch }}.dmg"

          if [ -d "$APP_PATH" ]; then
            echo "ðŸ“¦ Packaging $APP_PATH into $DMG_NAME..."

            # 1. åˆ›å»ºä¸´æ—¶é•œåƒ
            hdiutil create -size 200m -volname "LegalExtractor" -type SPARSE -fs HFS+ -fsargs "-c c=64,a=16,e=16" tmp_image

            # 2. æŒ‚è½½
            MOUNT_POINT=$(hdiutil attach -nobrowse -noverify -noautoopen tmp_image.sparseimage | grep "Apple_HFS" | awk '{print $3}')
            echo "ðŸ’¿ Mounted at: $MOUNT_POINT"

            # 3. å¤åˆ¶ App
            cp -R "$APP_PATH" "$MOUNT_POINT/"
            ln -s /Applications "$MOUNT_POINT/Applications"

            # 4. å¸è½½å¹¶è½¬æ¢
            hdiutil detach "$MOUNT_POINT"
            hdiutil convert tmp_image.sparseimage -format UDZO -o "build/bin/$DMG_NAME"
            rm tmp_image.sparseimage

            echo "âœ… DMG Packaging complete"
          else
            echo "âŒ App bundle not found at $APP_PATH"
            exit 1
          fi

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            build/bin/*.dmg

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build Windows OCR Bridge
        shell: powershell
        run: |
          dotnet publish internal/extractor/bridge_bin/win_ocr/WinOcrBridge.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -o build/bin/bridge_bin

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Wails App
        shell: powershell
        env:
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
          BAIDU_TOKEN: ${{ secrets.BAIDU_TOKEN }}
        run: |
          # ä»Ž GitHub Secrets ç”ŸæˆåµŒå…¥é…ç½®
          New-Item -ItemType Directory -Path "internal/config" -Force | Out-Null
          @"
          tencent:
            secret_id: "$env:TENCENT_SECRET_ID"
            secret_key: "$env:TENCENT_SECRET_KEY"
          baidu:
            token: "$env:BAIDU_TOKEN"
          "@ | Out-File -FilePath "internal/config/baked_conf.yaml" -Encoding UTF8

          cd frontend
          npm install
          npm run build
          cd ..

          # æ³¨å…¥æž„å»ºæ—¶é—´æˆ³å¹¶æž„å»ºåŽŸç”Ÿåº”ç”¨
          $BUILD_TIME = [int][double]::Parse((Get-Date -UFormat %s))
          wails build -platform windows/amd64 -s -ldflags "-X 'legal-extractor/internal/config.BuildTime=$BUILD_TIME'"

      - name: Package Windows
        shell: powershell
        run: |
          $VERSION = "${{ github.ref_name }}" -replace "v",""
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "dev" }

          # åˆ›å»ºåˆ†å‘ç›®å½•
          $DistDir = "build/bin/legal-extractor-windows-amd64"
          New-Item -ItemType Directory -Path $DistDir -Force | Out-Null

          # å¤åˆ¶ä¸»ç¨‹åº
          Copy-Item "build/bin/legal-extractor.exe" -Destination "$DistDir/legal-extractor.exe"

          # å¤åˆ¶è¯†åˆ«å¼•æ“Žç›®å½• (ç¡®ä¿ bridge_bin å­˜åœ¨)
          if (Test-Path "build/bin/bridge_bin") {
              Copy-Item -Path "build/bin/bridge_bin" -Destination "$DistDir/" -Recurse
          }

          # æ‰“åŒ…ä¸º ZIP
          Compress-Archive -Path "$DistDir/*" -DestinationPath "build/bin/legal-extractor_${VERSION}_windows_amd64.zip"

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: build/bin/*.zip

  build-docker:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            GOPROXY=https://proxy.golang.org,direct

  release:
    needs: [build-macos, build-windows, build-docker]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Prepare Release Assets
        run: |
          mkdir -p final-assets

          # æ”¶é›†æ‰€æœ‰äº§ç‰©åˆ°æ ¹ç›®å½• (åŒ…å« DMG å’Œ ZIP)
          find release-assets -type f \( -name "*.dmg" -o -name "*.zip" \) -exec cp {} final-assets/ \;

          # æ”¶é›†å¯¹åº”çš„ Release Notes MD æ–‡ä»¶ä½œä¸ºèµ„äº§
          VERSION_FILE="docs/releases/${{ github.ref_name }}.md"
          if [ -f "$VERSION_FILE" ]; then
            cp "$VERSION_FILE" final-assets/
          fi

          echo "ðŸ“‹ Final assets to upload:"
          ls -lah final-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: final-assets/*
          # ä½¿ç”¨ç²¾å¿ƒç¼–å†™çš„ MD æ–‡ä»¶ä½œä¸º Release çš„æ­£æ–‡å†…å®¹
          body_path: docs/releases/${{ github.ref_name }}.md
          generate_release_notes: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
