name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - platform: darwin/amd64
            arch: amd64
          - platform: darwin/arm64
            arch: arm64

    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Wails App
        run: |
          # V2.0 çº¯ Go æ¶æ„æ„å»ºï¼šæ— éœ€ Python ä¾èµ–
          cd frontend
          npm install
          npm run build
          cd ..

          # æ„å»ºåŸç”Ÿåº”ç”¨
          wails build -platform ${{ matrix.platform }} -s

      - name: Create DMG (Manual Method)
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ]; then
            VERSION="dev"
          fi

          APP_NAME="legal-extractor.app"
          APP_PATH="build/bin/$APP_NAME"
          DMG_NAME="legal-extractor_${VERSION}_darwin_${{ matrix.arch }}.dmg"

          if [ -d "$APP_PATH" ]; then
            echo "ğŸ“¦ Packaging $APP_PATH into $DMG_NAME..."

            # 1. åˆ›å»ºä¸´æ—¶é•œåƒ
            hdiutil create -size 200m -volname "LegalExtractor" -type SPARSE -fs HFS+ -fsargs "-c c=64,a=16,e=16" tmp_image

            # 2. æŒ‚è½½
            MOUNT_POINT=$(hdiutil attach -nobrowse -noverify -noautoopen tmp_image.sparseimage | grep "Apple_HFS" | awk '{print $3}')
            echo "ğŸ’¿ Mounted at: $MOUNT_POINT"

            # 3. å¤åˆ¶ App
            cp -R "$APP_PATH" "$MOUNT_POINT/"
            ln -s /Applications "$MOUNT_POINT/Applications"

            # 4. å¸è½½å¹¶è½¬æ¢
            hdiutil detach "$MOUNT_POINT"
            hdiutil convert tmp_image.sparseimage -format UDZO -o "build/bin/$DMG_NAME"
            rm tmp_image.sparseimage

            echo "âœ… DMG Packaging complete"
          else
            echo "âŒ App bundle not found at $APP_PATH"
            exit 1
          fi

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            build/bin/*.dmg

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Wails App
        shell: powershell
        run: |
          cd frontend
          npm install
          npm run build
          cd ..

          wails build -platform windows/amd64 -s

      - name: Package Windows
        shell: powershell
        run: |
          $VERSION = "${{ github.ref_name }}" -replace "v",""
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "dev" }

          cd build/bin
          if (Test-Path "legal-extractor.exe") {
            $TargetName = "legal-extractor_${VERSION}_windows_amd64.exe"
            Copy-Item "legal-extractor.exe" -Destination $TargetName
            # ä»…å‘å¸ƒ EXEï¼Œæ— éœ€å‹ç¼©åŒ…
          } else {
            Write-Error "âŒ Windows executable not found"
            exit 1
          }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: build/bin/*_windows_amd64.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Prepare Release Assets
        run: |
          mkdir -p final-assets

          # æ”¶é›†æ‰€æœ‰äº§ç‰©åˆ°æ ¹ç›®å½•
          find release-assets -type f \( -name "*.dmg" -o -name "*.exe" \) -exec cp {} final-assets/ \;

          echo "ğŸ“‹ Final assets to upload:"
          ls -lah final-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: final-assets/*
          # æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ RELEASE_NOTES ä¼šç”±è„šæœ¬ç”Ÿæˆæˆ–æ‰‹åŠ¨ç¼–è¾‘ï¼Œæˆ–è€…ç®€å•åœ°ä½¿ç”¨ git log
          # ä¸ºç®€å•èµ·è§ï¼Œè¿™é‡Œä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ Release Notes
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
